# 数据流和架构图

## 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          用户浏览器                                   │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  前端应用 (Next.js)                                           │  │
│  │  ┌─────────────────────────────────────────────────────────┐ │  │
│  │  │ 登录页面 (login/page.tsx)                                │ │  │
│  │  │ - 输入邮箱和密码                                         │ │  │
│  │  │ - 调用 /api/auth/login                                  │ │  │
│  │  │ - 保存 JWT Token 到 localStorage                        │ │  │
│  │  └─────────────────────────────────────────────────────────┘ │  │
│  │                          ↓                                      │  │
│  │  ┌─────────────────────────────────────────────────────────┐ │  │
│  │  │ 主页面 (page.tsx)                                        │ │  │
│  │  │ - 检查 Token，未登录跳转到登录页                         │ │  │
│  │  │ - 显示历史记录列表（左侧）                               │ │  │
│  │  │ - 显示聊天输入框和结果（右侧）                           │ │  │
│  │  │ - 所有请求都携带 Authorization Header                   │ │  │
│  │  └─────────────────────────────────────────────────────────┘ │  │
│  │                                                                │  │
│  │  lib/auth.ts                                                   │  │
│  │  - setToken() / getToken()                                    │  │
│  │  - getAuthHeader() / getFullHeaders()                         │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                              ↓ HTTP(S)
                    Authorization: Bearer <JWT>
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        后端 API (FastAPI)                            │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ 中间件层                                                      │  │
│  │ ┌────────────────────────────────────────────────────────┐   │  │
│  │ │ CORS 中间件 - 允许跨域请求                              │   │  │
│  │ │ 认证中间件 - 验证 JWT Token，提取 user_id              │   │  │
│  │ └────────────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              ↓                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ 路由层 (main.py)                                              │  │
│  │                                                                │  │
│  │ POST /api/workflow                                            │  │
│  │   ├─ 验证 user_id                                            │  │
│  │   ├─ 调用 orchestrator.run_workflow(topic, user_id)          │  │
│  │   └─ 返回结果                                                │  │
│  │                                                                │  │
│  │ GET /api/history                                              │  │
│  │   ├─ 验证 user_id                                            │  │
│  │   ├─ 调用 orchestrator.get_workflow_history(user_id)         │  │
│  │   └─ 返回该用户的历史记录                                    │  │
│  │                                                                │  │
│  │ DELETE /api/workflow/{workflow_id}                            │  │
│  │   ├─ 验证 user_id                                            │  │
│  │   ├─ 检查 workflow 是否属于该 user_id                        │  │
│  │   ├─ 执行软删除                                              │  │
│  │   └─ 返回结果                                                │  │
│  │                                                                │  │
│  │ POST /api/workflow/{workflow_id}/restore                      │  │
│  │   ├─ 验证 user_id                                            │  │
│  │   ├─ 恢复软删除的记录                                        │  │
│  │   └─ 返回结果                                                │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              ↓                                       │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ 业务逻辑层 (orchestrator.py)                                  │  │
│  │                                                                │  │
│  │ NexusOrchestrator 类                                          │  │
│  │ ├─ run_workflow(topic, user_id)                              │  │
│  │ │  ├─ 规划任务                                              │  │
│  │ │  ├─ 并发执行智能体                                        │  │
│  │ │  ├─ 保存到 Supabase（带 user_id）                         │  │
│  │ │  └─ 返回结果                                              │  │
│  │ │                                                             │  │
│  │ ├─ get_workflow_history(user_id)                             │  │
│  │ │  ├─ 查询 Supabase                                         │  │
│  │ │  ├─ 过滤 user_id                                          │  │
│  │ │  ├─ 过滤 is_deleted = false                               │  │
│  │ │  └─ 返回列表                                              │  │
│  │ │                                                             │  │
│  │ ├─ delete_workflow(workflow_id, user_id)                     │  │
│  │ │  ├─ 验证权限                                              │  │
│  │ │  ├─ 更新 is_deleted = true                                │  │
│  │ │  └─ 返回结果                                              │  │
│  │ │                                                             │  │
│  │ └─ restore_workflow(workflow_id, user_id)                    │  │
│  │    ├─ 验证权限                                              │  │
│  │    ├─ 更新 is_deleted = false                               │  │
│  │    └─ 返回结果                                              │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                              ↓ SQL 查询
                    user_id 自动过滤
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      Supabase 数据库                                 │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │ nexus_workflows 表                                            │  │
│  │                                                                │  │
│  │ 列名              类型          说明                           │  │
│  │ ─────────────────────────────────────────────────────────── │  │
│  │ id               UUID          工作流 ID                      │  │
│  │ user_id          UUID          用户 ID（关键！）              │  │
│  │ topic            TEXT          用户输入的主题                 │  │
│  │ result           JSONB         AI 执行结果                    │  │
│  │ is_deleted       BOOLEAN       软删除标记                     │  │
│  │ deleted_at       TIMESTAMP     删除时间                       │  │
│  │ created_at       TIMESTAMP     创建时间                       │  │
│  │ updated_at       TIMESTAMP     更新时间                       │  │
│  │                                                                │  │
│  │ 索引：                                                         │  │
│  │ - idx_nexus_workflows_user_id                                │  │
│  │ - idx_nexus_workflows_user_created                           │  │
│  │ - idx_nexus_workflows_deleted                                │  │
│  │                                                                │  │
│  │ RLS 策略：                                                    │  │
│  │ - 用户只能查看自己的记录                                     │  │
│  │ - 用户只能修改自己的记录                                     │  │
│  │ - 用户只能删除自己的记录                                     │  │
│  └──────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 2. 用户认证流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     用户登录流程                                  │
└─────────────────────────────────────────────────────────────────┘

1️⃣ 用户访问应用
   ├─ 检查 localStorage 中是否有 Token
   ├─ 如果没有 → 跳转到 /login
   └─ 如果有 → 进入主页面

2️⃣ 用户在登录页输入邮箱和密码
   │
   ├─ 点击"登录"按钮
   │
   └─ 前端发送 POST /api/auth/login
      {
        "email": "user@example.com",
        "password": "password123"
      }

3️⃣ 后端验证凭证
   │
   ├─ 查询数据库，验证邮箱和密码
   ├─ 如果验证失败 → 返回 401 Unauthorized
   └─ 如果验证成功 → 生成 JWT Token

4️⃣ 后端返回 Token
   │
   └─ 返回 200 OK
      {
        "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
        "token_type": "bearer"
      }

5️⃣ 前端保存 Token
   │
   ├─ localStorage.setItem('auth_token', token)
   ├─ 跳转到主页面 /
   └─ 主页面加载

6️⃣ 用户在主页面操作
   │
   ├─ 所有 API 请求都自动添加 Authorization Header
   │  Authorization: Bearer <token>
   │
   └─ 后端中间件验证 Token
      ├─ 解码 JWT，提取 user_id
      ├─ 如果 Token 无效 → 返回 401，前端跳转到登录页
      └─ 如果 Token 有效 → 继续处理请求，自动过滤 user_id

7️⃣ 用户登出
   │
   ├─ 点击"登出"按钮
   ├─ localStorage.removeItem('auth_token')
   └─ 跳转到登录页
```

---

## 3. 创建工作流的数据流

```
┌─────────────────────────────────────────────────────────────────┐
│              用户创建新工作流的完整流程                            │
└─────────────────────────────────────────────────────────────────┘

前端 (page.tsx)
│
├─ 用户输入主题，点击"开始"按钮
│
├─ 发送 POST /api/workflow
│  {
│    "topic": "如何做好市场营销"
│  }
│  Headers: {
│    "Content-Type": "application/json",
│    "Authorization": "Bearer <token>"
│  }
│
└─ 显示加载动画，等待响应

                    ↓ HTTP 请求

后端 (main.py)
│
├─ 接收请求
│
├─ 中间件：验证 Authorization Header
│  ├─ 解码 JWT Token
│  ├─ 提取 user_id（例如：550e8400-e29b-41d4-a716-446655440000）
│  └─ 如果验证失败 → 返回 401，停止处理
│
├─ 路由处理：create_workflow(request, user_id)
│
└─ 调用 orchestrator.run_workflow(topic, user_id)

                    ↓

业务逻辑 (orchestrator.py)
│
├─ 规划任务：_plan_tasks(topic)
│  ├─ 调用 GPT，拆解任务
│  └─ 返回 ["市场分析师:分析市场规模", "技术专家:评估核心壁垒", ...]
│
├─ 并发执行：asyncio.gather(*tasks)
│  ├─ 任务1：_run_single_agent("市场分析师", "分析市场规模")
│  ├─ 任务2：_run_single_agent("技术专家", "评估核心壁垒")
│  └─ 任务3：_run_single_agent("风险评估员", "列出潜在风险")
│
├─ 汇总结果：WorkflowResponse
│  {
│    "workflow_id": "a1b2c3d4",
│    "topic": "如何做好市场营销",
│    "results": [
│      {
│        "agent_name": "市场分析师",
│        "content": "市场规模约为 XXX...",
│        "duration": 2.5
│      },
│      ...
│    ],
│    "total_time": 7.8
│  }
│
└─ 保存到 Supabase
   INSERT INTO nexus_workflows (
     user_id,
     topic,
     result,
     is_deleted
   ) VALUES (
     '550e8400-e29b-41d4-a716-446655440000',  ← 关键！
     '如何做好市场营销',
     '{"workflow_id": "a1b2c3d4", ...}',
     false
   )

                    ↓ 返回响应

前端 (page.tsx)
│
├─ 接收响应
│
├─ 更新状态：setData(result)
│
├─ 刷新历史列表：fetchHistory()
│
└─ 隐藏加载动画，显示结果
```

---

## 4. 获取历史记录的数据流

```
┌─────────────────────────────────────────────────────────────────┐
│              获取用户历史记录的完整流程                            │
└─────────────────────────────────────────────────────────────────┘

前端 (page.tsx)
│
├─ 页面加载时，调用 fetchHistory()
│
├─ 发送 GET /api/history
│  Headers: {
│    "Authorization": "Bearer <token>"
│  }
│
└─ 等待响应

                    ↓ HTTP 请求

后端 (main.py)
│
├─ 接收请求
│
├─ 中间件：验证 Token，提取 user_id
│  user_id = "550e8400-e29b-41d4-a716-446655440000"
│
├─ 路由处理：get_history(user_id)
│
└─ 调用 orchestrator.get_workflow_history(user_id)

                    ↓

业务逻辑 (orchestrator.py)
│
└─ 查询 Supabase
   SELECT * FROM nexus_workflows
   WHERE user_id = '550e8400-e29b-41d4-a716-446655440000'
     AND is_deleted = false
   ORDER BY created_at DESC
   LIMIT 10

   ⭐️ 关键点：
   - WHERE user_id = ... 确保只返回该用户的数据
   - AND is_deleted = false 排除已删除的记录
   - 其他用户的数据完全看不到

                    ↓ 返回结果

后端 (orchestrator.py)
│
└─ 返回列表
   [
     {
       "id": "uuid-1",
       "user_id": "550e8400-e29b-41d4-a716-446655440000",
       "topic": "如何做好市场营销",
       "result": {...},
       "is_deleted": false,
       "created_at": "2024-01-15T10:30:00Z"
     },
     {
       "id": "uuid-2",
       "user_id": "550e8400-e29b-41d4-a716-446655440000",
       "topic": "Python 最佳实践",
       "result": {...},
       "is_deleted": false,
       "created_at": "2024-01-14T15:20:00Z"
     },
     ...
   ]

                    ↓ 返回响应

前端 (page.tsx)
│
├─ 接收响应
│
├─ 更新状态：setHistory(list)
│
└─ 在左侧侧边栏显示历史列表
```

---

## 5. 删除工作流的数据流

```
┌─────────────────────────────────────────────────────────────────┐
│              删除工作流的完整流程（软删除）                        │
└─────────────────────────────────────────────────────────────────┘

前端 (page.tsx)
│
├─ 用户点击历史记录旁的"删除"按钮
│
├─ 弹出确认对话框
│  "确定要删除这条记录吗？"
│
├─ 用户点击"确定"
│
├─ 发送 DELETE /api/workflow/uuid-1
│  Headers: {
│    "Authorization": "Bearer <token>"
│  }
│
└─ 等待响应

                    ↓ HTTP 请求

后端 (main.py)
│
├─ 接收请求
│
├─ 中间件：验证 Token，提取 user_id
│  user_id = "550e8400-e29b-41d4-a716-446655440000"
│
├─ 路由处理：delete_workflow(workflow_id="uuid-1", user_id)
│
└─ 调用 orchestrator.delete_workflow("uuid-1", user_id)

                    ↓

业务逻辑 (orchestrator.py)
│
├─ 第一步：验证权限
│  SELECT id FROM nexus_workflows
│  WHERE id = 'uuid-1'
│    AND user_id = '550e8400-e29b-41d4-a716-446655440000'
│
│  ⭐️ 关键检查：
│  - 如果没有找到记录 → 返回 False（可能是其他用户的记录）
│  - 如果找到记录 → 继续删除
│
├─ 第二步：执行软删除
│  UPDATE nexus_workflows
│  SET is_deleted = true,
│      deleted_at = now()
│  WHERE id = 'uuid-1'
│    AND user_id = '550e8400-e29b-41d4-a716-446655440000'
│
│  ⭐️ 重要：
│  - 数据不会真正被删除
│  - 只是标记为已删除
│  - 可以随时恢复
│
└─ 返回 True（删除成功）

                    ↓ 返回响应

后端 (main.py)
│
├─ 检查删除结果
│
├─ 如果成功 → 返回 200 OK
│  {
│    "message": "Workflow deleted successfully"
│  }
│
└─ 如果失败 → 返回 404 Not Found
   {
     "detail": "Workflow not found or you don't have permission"
   }

                    ↓ 返回响应

前端 (page.tsx)
│
├─ 接收响应
│
├─ 如果成功
│  ├─ 刷新历史列表：fetchHistory()
│  ├─ 清空当前显示的结果：setData(null)
│  ├─ 显示成功提示
│  └─ 用户看到该记录从列表中消失
│
└─ 如果失败
   ├─ 显示错误提示
   └─ 历史列表保持不变
```

---

## 6. 数据隔离示例

```
┌─────────────────────────────────────────────────────────────────┐
│              多用户场景下的数据隔离                                │
└─────────────────────────────────────────────────────────────────┘

数据库中的数据：
┌────────────────────────────────────────────────────────────────┐
│ nexus_workflows 表                                               │
├────────────────────────────────────────────────────────────────┤
│ id   │ user_id              │ topic        │ is_deleted        │
├──────┼──────────────────────┼──────────────┼───────────────────┤
│ 001  │ user-A (550e8400...) │ 市场营销     │ false             │
│ 002  │ user-A (550e8400...) │ Python 教程  │ false             │
│ 003  │ user-B (660e8400...) │ 数据分析     │ false             │
│ 004  │ user-B (660e8400...) │ 机器学习     │ false             │
│ 005  │ user-A (550e8400...) │ 删除的记录   │ true              │
└────────────────────────────────────────────────────────────────┘

场景 1️⃣：用户 A 查询历史记录
┌─────────────────────────────────────────────────────────────┐
│ 用户 A 的 Token 中 user_id = 550e8400...                    │
│                                                              │
│ 查询语句：                                                   │
│ SELECT * FROM nexus_workflows                               │
│ WHERE user_id = '550e8400...'                               │
│   AND is_deleted = false                                    │
│                                                              │
│ 返回结果：                                                   │
│ ✅ 001 - 市场营销                                            │
│ ✅ 002 - Python 教程                                         │
│ ❌ 003 - 数据分析（不返回，因为属于 user-B）                 │
│ ❌ 004 - 机器学习（不返回，因为属于 user-B）                 │
│ ❌ 005 - 删除的记录（不返回，因为已删除）                    │
└─────────────────────────────────────────────────────────────┘

场景 2️⃣：用户 B 查询历史记录
┌─────────────────────────────────────────────────────────────┐
│ 用户 B 的 Token 中 user_id = 660e8400...                    │
│                                                              │
│ 查询语句：                                                   │
│ SELECT * FROM nexus_workflows                               │
│ WHERE user_id = '660e8400...'                               │
│   AND is_deleted = false                                    │
│                                                              │
│ 返回结果：                                                   │
│ ❌ 001 - 市场营销（不返回，因为属于 user-A）                 │
│ ❌ 002 - Python 教程（不返回，因为属于 user-A）              │
│ ✅ 003 - 数据分析                                            │
│ ✅ 004 - 机器学习                                            │
│ ❌ 005 - 删除的记录（不返回，因为已删除）                    │
└─────────────────────────────────────────────────────────────┘

场景 3️⃣：用户 A 尝试删除用户 B 的记录
┌─────────────────────────────────────────────────────────────┐
│ 用户 A 的 Token 中 user_id = 550e8400...                    │
│ 用户 A 尝试删除 id = 003 的记录                              │
│                                                              │
│ 删除语句：                                                   │
│ UPDATE nexus_workflows                                       │
│ SET is_deleted = true                                        │
│ WHERE id = '003'                                             │
│   AND user_id = '550e8400...'                               │
│                                                              │
│ 结果：                                                       │
│ ❌ 没有找到匹配的记录（因为 003 属于 user-B）                │
│ ❌ 返回 404 Not Found                                        │
│ ❌ 用户 B 的数据保持不变                                     │
└─────────────────────────────────────────────────────────────┘

场景 4️⃣：数据库级别的 RLS 保护
┌─────────────────────────────────────────────────────────────┐
│ 即使后端代码有 bug，忘记检查 user_id，                       │
│ 数据库的 RLS 策略也会保护数据：                               │
│                                                              │
│ 用户 A 尝试执行：                                            │
│ SELECT * FROM nexus_workflows WHERE id = '003'              │
│                                                              │
│ 数据库 RLS 检查：                                            │
│ - 当前用户 = user-A (550e8400...)                           │
│ - 记录的 user_id = user-B (660e8400...)                     │
│ - 不匹配！                                                   │
│                                                              │
│ 结果：                                                       │
│ ❌ 查询被拒绝                                                │
│ ❌ 返回 0 条记录                                             │
│ ✅ 数据安全得到保护                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 安全检查流程

```
┌─────────────────────────────────────────────────────────────────┐
│              每个 API 请求的安全检查流程                          │
└─────────────────────────────────────────────────────────────────┘

请求到达
  ↓
1️⃣ CORS 检查
  ├─ 请求来源是否在白名单中？
  ├─ 如果否 → 返回 403 Forbidden
  └─ 如果是 → 继续

  ↓
2️⃣ 认证检查
  ├─ Authorization Header 是否存在？
  ├─ 如果否 → 返回 401 Unauthorized
  └─ 如果是 → 继续

  ↓
3️⃣ Token 验证
  ├─ Token 格式是否正确？
  ├─ Token 签名是否有效？
  ├─ Token 是否过期？
  ├─ 如果任何检查失败 → 返回 401 Unauthorized
  └─ 如果都通过 → 继续

  ↓
4️⃣ 提取 user_id
  ├─ 从 Token 中解码 user_id
  └─ 注入到请求上下文中

  ↓
5️⃣ 业务逻辑处理
  ├─ 执行业务逻辑
  ├─ 所有数据库查询都自动过滤 user_id
  └─ 继续

  ↓
6️⃣ 返回响应
  ├─ 返回 200 OK 和数据
  └─ 只返回该用户的数据

┌─────────────────────────────────────────────────────────────────┐
│ 双重保护机制                                                     │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│ 第一层：后端代码检查                                             │
│ ├─ 所有查询都过滤 user_id                                       │
│ ├─ 删除前验证权限                                               │
│ └─ 防止代码 bug 导致数据泄露                                    │
│                                                                  │
│ 第二层：数据库 RLS 策略                                          │
│ ├─ 即使代码有 bug，RLS 也会拦截                                │
│ ├─ 用户只能访问自己的数据                                       │
│ └─ 防止数据库直接被攻击                                         │
│                                                                  │
│ 结果：即使一层防护失效，另一层仍然保护数据                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8. 性能优化路径

```
┌─────────────────────────────────────────────────────────────────┐
│              数据查询的性能优化                                    │
└─────────────────────────────────────────────────────────────────┘

❌ 未优化的查询
┌──────────────────────────────────────────────────────────────┐
│ SELECT * FROM nexus_workflows                                │
│ WHERE user_id = '550e8400...'                                │
│ ORDER BY created_at DESC                                     │
│ LIMIT 10                                                     │
│                                                              │
│ 问题：                                                       │
│ - 没有索引，需要全表扫描                                     │
│ - 返回所有列，包括大的 JSONB result 字段                     │
│ - 没有分页，可能返回太多数据                                 │
│ - 性能：~500ms                                              │
└──────────────────────────────────────────────────────────────┘

✅ 优化后的查询
┌──────────────────────────────────────────────────────────────┐
│ -- 使用索引和选择性列                                         │
│ SELECT id, topic, created_at, is_deleted                     │
│ FROM nexus_workflows                                          │
│ WHERE user_id = '550e8400...'                                │
│   AND is_deleted = false                                     │
│ ORDER BY created_at DESC                                     │
│ LIMIT 10                                                     │
│ OFFSET 0                                                     │
│                                                              │
│ 优化点：                                                     │
│ - 使用 idx_nexus_workflows_user_created 索引                 │
│ - 只选择需要的列（id, topic, created_at）                   │
│ - 不选择大的 result 字段                                     │
│ - 支持分页（OFFSET）                                         │
│ - 性能：~10ms（快 50 倍！）                                  │
└──────────────────────────────────────────────────────────────┘

📊 索引策略
┌──────────────────────────────────────────────────────────────┐
│ 索引 1：单列索引（user_id）                                   │
│ CREATE INDEX idx_nexus_workflows_user_id                     │
│ ON nexus_workflows(user_id);                                 │
│                                                              │
│ 用途：快速过滤特定用户的数据                                 │
│                                                              │
│ ─────────────────────────────────────────────────────────── │
│                                                              │
│ 索引 2：复合索引（user_id, created_at）                      │
│ CREATE INDEX idx_nexus_workflows_user_created                │
│ ON nexus_workflows(user_id, created_at DESC);                │
│                                                              │
│ 用途：快速获取用户的最新记录（排序）                         │
│                                                              │
│ ─────────────────────────────────────────────────────────── │
│                                                              │
│ 索引 3：复合索引（user_id, is_deleted）                      │
│ CREATE INDEX idx_nexus_workflows_deleted                     │
│ ON nexus_workflows(user_id, is_deleted);                     │
│                                                              │
│ 用途：快速过滤未删除的记录                                   │
└──────────────────────────────────────────────────────────────┘
```

---

## 总结

这个架构提供了：

1. **完全的数据隔离** - 用户只能看到自己的数据
2. **双重安全保护** - 后端代码 + 数据库 RLS
3. **软删除机制** - 可以恢复已删除的数据
4. **高性能查询** - 通过索引优化
5. **易于扩展** - 支持添加更多功能（权限管理、分享等）


