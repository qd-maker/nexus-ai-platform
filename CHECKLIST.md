# 实施检查清单

## 📋 数据库层面

### 表结构修改
- [ ] 添加 `user_id` 字段
- [ ] 添加 `is_deleted` 字段
- [ ] 添加 `deleted_at` 字段
- [ ] 验证字段类型正确
  - [ ] `user_id` 是 UUID
  - [ ] `is_deleted` 是 BOOLEAN
  - [ ] `deleted_at` 是 TIMESTAMP

### 索引创建
- [ ] 创建 `idx_nexus_workflows_user_id` 索引
- [ ] 创建 `idx_nexus_workflows_user_created` 索引
- [ ] 创建 `idx_nexus_workflows_deleted` 索引
- [ ] 验证索引已创建（查询 `pg_indexes`）

### RLS 策略
- [ ] 启用 RLS：`ALTER TABLE nexus_workflows ENABLE ROW LEVEL SECURITY`
- [ ] 创建 SELECT 策略
- [ ] 创建 INSERT 策略
- [ ] 创建 UPDATE 策略
- [ ] 创建 DELETE 策略
- [ ] 测试 RLS（用不同用户查询）

### 数据迁移
- [ ] 备份原始数据
- [ ] 为现有记录填充 `user_id`（如果有的话）
  ```sql
  UPDATE nexus_workflows 
  SET user_id = '00000000-0000-0000-0000-000000000000'
  WHERE user_id IS NULL;
  ```
- [ ] 验证数据完整性

---

## 🔧 后端改造

### 认证中间件
- [ ] 创建 `backend/app/middleware/__init__.py`
- [ ] 创建 `backend/app/middleware/auth.py`
- [ ] 实现 `JWTHandler` 类
- [ ] 实现 `verify_token()` 方法
- [ ] 测试 Token 验证
  - [ ] 有效 Token 返回 user_id
  - [ ] 无效 Token 返回 401
  - [ ] 过期 Token 返回 401

### orchestrator.py 修改
- [ ] 修改 `run_workflow()` 方法签名
  ```python
  async def run_workflow(self, topic: str, user_id: str) -> WorkflowResponse:
  ```
- [ ] 保存时添加 `user_id`
- [ ] 修改 `get_workflow_history()` 方法
  ```python
  def get_workflow_history(self, user_id: str, limit: int = 10):
  ```
- [ ] 查询时过滤 `user_id`
- [ ] 查询时过滤 `is_deleted = false`
- [ ] 添加 `delete_workflow()` 方法
- [ ] 添加 `restore_workflow()` 方法
- [ ] 测试所有方法

### main.py 修改
- [ ] 导入认证相关模块
- [ ] 创建 `get_current_user()` 依赖函数
- [ ] 修改 `/api/workflow` 端点
  - [ ] 添加 `user_id` 参数
  - [ ] 传递 `user_id` 给 orchestrator
- [ ] 修改 `/api/history` 端点
  - [ ] 添加 `user_id` 参数
  - [ ] 传递 `user_id` 给 orchestrator
- [ ] 添加 `/api/workflow/{workflow_id}` DELETE 端点
  - [ ] 验证权限
  - [ ] 返回 404 如果没有权限
- [ ] 添加 `/api/workflow/{workflow_id}/restore` POST 端点
  - [ ] 验证权限
  - [ ] 返回 404 如果没有权限
- [ ] 测试所有端点

### 环境变量
- [ ] 设置 `JWT_SECRET`
- [ ] 验证 `SUPABASE_URL` 正确
- [ ] 验证 `SUPABASE_KEY` 正确
- [ ] 验证 `OPENAI_API_KEY` 正确

### 后端测试
- [ ] 测试无 Token 请求返回 401
- [ ] 测试无效 Token 返回 401
- [ ] 测试有效 Token 请求成功
- [ ] 测试用户 A 只能看到自己的数据
- [ ] 测试用户 B 只能看到自己的数据
- [ ] 测试用户 A 无法删除用户 B 的数据
- [ ] 测试软删除功能
- [ ] 测试恢复功能

---

## 🎨 前端改造

### 认证工具库
- [ ] 创建 `frontend/lib/auth.ts`
- [ ] 实现 `setToken()`
- [ ] 实现 `getToken()`
- [ ] 实现 `removeToken()`
- [ ] 实现 `isAuthenticated()`
- [ ] 实现 `getAuthHeader()`
- [ ] 实现 `getFullHeaders()`
- [ ] 测试所有函数

### 主页面修改
- [ ] 添加认证检查
  ```typescript
  useEffect(() => {
    if (!getToken()) {
      router.push('/login');
    }
  }, [router]);
  ```
- [ ] 修改 `fetchHistory()` 添加认证头
- [ ] 修改 `startWorkflow()` 添加认证头
- [ ] 添加 `deleteWorkflow()` 方法
- [ ] 添加 `restoreWorkflow()` 方法（可选）
- [ ] 在 UI 中添加删除按钮
- [ ] 测试所有功能

### 登录页面
- [ ] 创建 `frontend/app/login/page.tsx`
- [ ] 实现邮箱输入框
- [ ] 实现密码输入框
- [ ] 实现登录按钮
- [ ] 实现错误提示
- [ ] 实现 `handleLogin()` 函数
- [ ] 测试登录流程

### 前端测试
- [ ] 未登录时访问主页自动跳转到登录页
- [ ] 登录后保存 Token 到 localStorage
- [ ] 登录后跳转到主页
- [ ] 主页加载时自动获取历史记录
- [ ] 创建新工作流时自动添加认证头
- [ ] 删除工作流时自动添加认证头
- [ ] 删除后历史列表自动刷新
- [ ] 登出后 Token 被删除
- [ ] 登出后跳转到登录页

---

## 🔐 安全检查

### 代码审查
- [ ] 所有 API 端点都使用 `Depends(get_current_user)`
- [ ] 所有数据库查询都过滤 `user_id`
- [ ] 所有删除操作都验证权限
- [ ] 没有硬编码的密钥
- [ ] 没有 SQL 注入漏洞
- [ ] 没有 XSS 漏洞

### 数据库安全
- [ ] RLS 已启用
- [ ] RLS 策略已创建
- [ ] 测试 RLS 是否生效
- [ ] 没有超级用户权限泄露

### 认证安全
- [ ] JWT_SECRET 使用强密码
- [ ] Token 有过期时间
- [ ] Token 存储在 localStorage（或更安全的地方）
- [ ] 支持 Token 刷新（可选）
- [ ] 支持登出功能

### 网络安全
- [ ] 生产环境使用 HTTPS
- [ ] CORS 只允许你的域名
- [ ] 没有暴露敏感信息
- [ ] 实现了速率限制（可选）

---

## 📊 性能检查

### 索引验证
- [ ] 索引已创建
- [ ] 查询使用了索引（EXPLAIN ANALYZE）
- [ ] 查询性能满足要求（< 100ms）

### 查询优化
- [ ] 只选择需要的列
- [ ] 实现了分页（可选）
- [ ] 实现了缓存（可选）

### 压力测试
- [ ] 测试 10 个并发用户
- [ ] 测试 100 个并发用户
- [ ] 测试 1000 个并发用户
- [ ] 监控响应时间和错误率

---

## 📝 文档和日志

### 代码文档
- [ ] 添加了代码注释
- [ ] 添加了函数文档字符串
- [ ] 添加了类文档字符串

### 日志记录
- [ ] 记录所有认证失败
- [ ] 记录所有删除操作
- [ ] 记录所有错误
- [ ] 日志包含时间戳和用户 ID

### 部署文档
- [ ] 编写了部署指南
- [ ] 编写了故障排除指南
- [ ] 编写了 API 文档
- [ ] 编写了数据库 schema 文档

---

## 🚀 部署前检查

### 环境准备
- [ ] 生产数据库已备份
- [ ] 生产环境变量已配置
- [ ] SSL 证书已配置
- [ ] CDN 已配置（可选）

### 代码准备
- [ ] 所有代码已提交到版本控制
- [ ] 所有测试都通过
- [ ] 代码审查已完成
- [ ] 没有 TODO 或 FIXME 注释

### 监控准备
- [ ] 错误监控已配置（Sentry 等）
- [ ] 性能监控已配置（DataDog 等）
- [ ] 日志收集已配置（ELK 等）
- [ ] 告警已配置

### 备份和恢复
- [ ] 备份策略已制定
- [ ] 恢复流程已测试
- [ ] 灾难恢复计划已制定

---

## ✅ 部署后检查

### 功能验证
- [ ] 登录功能正常
- [ ] 创建工作流正常
- [ ] 获取历史记录正常
- [ ] 删除工作流正常
- [ ] 恢复工作流正常（如果实现了）

### 数据验证
- [ ] 用户 A 只能看到自己的数据
- [ ] 用户 B 只能看到自己的数据
- [ ] 用户 A 无法访问用户 B 的数据
- [ ] 删除后数据被标记为已删除（不是真正删除）

### 性能验证
- [ ] 响应时间 < 100ms
- [ ] 错误率 < 0.1%
- [ ] CPU 使用率 < 70%
- [ ] 内存使用率 < 70%

### 安全验证
- [ ] 无 Token 请求返回 401
- [ ] 无效 Token 请求返回 401
- [ ] 权限验证正常工作
- [ ] RLS 策略正常工作

### 监控验证
- [ ] 错误告警正常
- [ ] 性能告警正常
- [ ] 日志收集正常
- [ ] 仪表板显示正确数据

---

## 🔄 定期维护

### 每周
- [ ] 检查错误日志
- [ ] 检查性能指标
- [ ] 检查安全告警

### 每月
- [ ] 备份数据库
- [ ] 审查用户活动
- [ ] 更新依赖包
- [ ] 检查安全补丁

### 每季度
- [ ] 性能优化
- [ ] 容量规划
- [ ] 安全审计
- [ ] 用户反馈收集

### 每年
- [ ] 架构审查
- [ ] 灾难恢复演练
- [ ] 安全渗透测试
- [ ] 成本优化

---

## 📞 故障排除

### 常见问题

**问题：用户无法登录**
- [ ] 检查 JWT_SECRET 是否正确
- [ ] 检查 Token 是否过期
- [ ] 检查数据库连接
- [ ] 查看错误日志

**问题：用户看到其他用户的数据**
- [ ] 检查查询是否过滤 user_id
- [ ] 检查 RLS 策略是否启用
- [ ] 检查 RLS 策略是否正确
- [ ] 查看数据库日志

**问题：删除操作失败**
- [ ] 检查权限验证逻辑
- [ ] 检查数据库连接
- [ ] 检查 is_deleted 字段是否存在
- [ ] 查看错误日志

**问题：性能缓慢**
- [ ] 检查索引是否创建
- [ ] 检查查询是否使用索引（EXPLAIN ANALYZE）
- [ ] 检查数据库连接池
- [ ] 监控数据库负载

---

## 📊 验收标准

### 功能验收
- [ ] 所有功能都能正常工作
- [ ] 没有已知的 bug
- [ ] 用户体验良好

### 性能验收
- [ ] 响应时间 < 100ms
- [ ] 支持 1000+ 并发用户
- [ ] 错误率 < 0.1%

### 安全验收
- [ ] 通过安全审计
- [ ] 没有已知的安全漏洞
- [ ] 符合 OWASP 最佳实践

### 文档验收
- [ ] 代码文档完整
- [ ] API 文档完整
- [ ] 部署文档完整
- [ ] 故障排除指南完整

---

## 🎉 完成标志

当以下所有项目都完成时，你可以宣布项目成功：

- [ ] 所有检查清单项目都已完成
- [ ] 所有测试都通过
- [ ] 所有文档都已编写
- [ ] 生产环境已部署
- [ ] 监控和告警已配置
- [ ] 用户反馈良好
- [ ] 没有已知的 bug 或安全问题

---

**祝贺！你已经成功实施了多用户数据隔离方案！** 🎊

现在你可以：
1. 邀请更多用户使用你的应用
2. 放心地添加新功能
3. 扩展到更多用户
4. 实现更复杂的权限管理

**下一步建议：**
- 实现用户注册功能
- 添加用户资料管理
- 实现分享功能
- 添加权限管理
- 实现审计日志


